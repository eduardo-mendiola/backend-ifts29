extends ../layout.pug

block content
  .d-flex.justify-content-between.align-items-center.mb-4
    h1.mb-0 Lista de Usuarios del Sistema
    a.btn.btn-primary(href="/users/new") Nuevo Usuario

  table.table.table-hover.table-dark
    thead
      tr
        th ID
        th Nombre
        th Apellido
        th.text-end.pe-5 Acciones
    tbody
      each item in items
        tr(data-id=item.id, data-name=`${item.first_name} ${item.last_name}`)
          td= item.id
          td= item.first_name
          td= item.last_name
          td.text-end
            a.btn.btn-gray.btn-sm.me-2(href=`/users/${item.id}`) Ver
            a.btn.btn-gray.btn-sm.me-2(href=`/users/${item.id}/edit`) Editar
            form(action=`/api/users/${item.id}?_method=DELETE`, method="POST", style="display:inline;")
              input(type="hidden", name="_method", value="DELETE")
              button.btn.btn-danger-soft.btn-sm.delete-btn(data-id=item.id) Eliminar

  // Modal de confirmación con Bootstrap
  div#confirmModal.modal.fade(tabindex="-1", aria-labelledby="confirmModalLabel", aria-hidden="true")
    div.modal-dialog.modal-dialog-centered
      div.modal-content.bg-dark.text-white
        div.modal-header
          h5#confirmModalLabel.modal-title.text-danger Está a punto de eliminar un usuario
          button.btn-close.btn-close-white(type="button", data-bs-dismiss="modal", aria-label="Close")
        div.modal-body
          p ¿Está seguro de que desea eliminar este usuario?
          p#userNameToDelete.font-weight-bold.mt-3
        div.modal-footer
          button#confirmYes.btn.btn-danger Eliminar
          button.btn.btn-secondary(data-bs-dismiss="modal") Cancelar
  // Toast de notificación
  div#toastContainer.position-fixed.top-0.end-0.p-3(style="z-index: 1055;")
    div#deleteToast.toast(role="alert", aria-live="assertive", aria-atomic="true")
      div.toast-header.bg-success.text-white
        strong.me-auto Éxito
        small Ahora
        button.btn-close.btn-close-white.ms-2(type="button", data-bs-dismiss="toast", aria-label="Close")
      div.toast-body
        Proyecto eliminado correctamente.


  script.
      document.addEventListener('DOMContentLoaded', () => {
        const deleteButtons = document.querySelectorAll('.delete-btn');
        const modalElement = document.getElementById('confirmModal');
        const modal = new bootstrap.Modal(modalElement);
        const confirmYes = document.getElementById('confirmYes');
        const userNameToDelete = document.getElementById('userNameToDelete');
        let userIdToDelete = null;
        let rowToDelete = null;

        deleteButtons.forEach(button => {
          button.addEventListener('click', (event) => {
            event.preventDefault(); // Prevenir el envío del formulario

            const row = event.target.closest('tr');
            userIdToDelete = event.target.dataset.id;
            rowToDelete = row;

            // Obtener el nombre y apellido del usuario
            const userName = row.dataset.name;

            // Actualizar el contenido del modal
            userNameToDelete.textContent = `Nombre: ${userName}`;

            // Mostrar el modal
            modal.show();
          });
        });

        confirmYes.addEventListener('click', async () => {
          if (userIdToDelete) {
            try {
              const response = await fetch(`/api/users/${userIdToDelete}`, {
                method: 'DELETE',
              });

              if (response.ok) {
                rowToDelete.remove(); // Eliminar la fila de la tabla
                //alert('Usuario eliminado correctamente.');
              } else {
                alert('Error al eliminar el usuario.');
              }
            } catch (error) {
              console.error('Error:', error);
              alert('Error al eliminar el usuario.');
            }
          }

          // Ocultar el modal
          modal.hide();
        });
      });